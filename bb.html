<!-- Tambahkan ini di bagian <head> setelah script Firebase yang sudah ada -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<!-- Tambahkan ini di bagian <body> setelah script yang sudah ada -->
<div id="firebase-test-container" style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; max-width: 600px; display: none;">
  <h3>üî• Firebase Connection Test</h3>
  <div id="test-results"></div>
  <button id="test-connection" style="background: var(--pink); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">Test Connection</button>
</div>

<script>
// Tambahkan ini setelah kode JavaScript yang sudah ada
const testFirebaseConnection = async () => {
  const resultsDiv = document.getElementById('test-results');
  const testContainer = document.getElementById('firebase-test-container');
  
  // Tampilkan container
  testContainer.style.display = 'block';
  resultsDiv.innerHTML = '<p>üîÑ Menguji koneksi ke Firebase...</p>';
  
  try {
    // Coba inisialisasi Firebase dengan konfigurasi default
    const testApp = firebase.initializeApp(defaultFirebaseConfig);
    
    // Coba akses ke Firestore
    const db = firebase.firestore();
    const testDoc = await db.collection('test').add({
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      test: 'connection'
    });
    
    // Coba Storage
    const storage = firebase.storage();
    const storageRef = storage.ref('test/test-file.txt');
    await storageRef.putString('Test file content');
    
    // Hapus dokumen test
    await db.collection('test').doc(testDoc.id).delete();
    
    // Hapus file test
    await storageRef.delete();
    
    resultsDiv.innerHTML = `
      <div class="success-box" style="margin-top: 15px;">
        ‚úÖ <strong>Koneksi Firebase Berhasil!</strong><br>
        <small>Project ID: ${defaultFirebaseConfig.projectId}</small><br>
        <small>Database: Firestore</small><br>
        <small>Storage: Firebase Storage</small>
      </div>
      <div style="margin-top: 15px;">
        <button onclick="applyRulesDirectly()" style="background: var(--green); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">Terapkan Rules Sekarang</button>
      </div>
    `;
  } catch (error) {
    resultsDiv.innerHTML = `
      <div class="warning-box" style="margin-top: 15px;">
        ‚ùå <strong>Koneksi Firebase Gagal!</strong><br>
        <small>Error: ${error.message}</small>
      </div>
    `;
  }
};

const applyRulesDirectly = async () => {
  const resultsDiv = document.getElementById('test-results');
  resultsDiv.innerHTML = '<p>üîÑ Menerapkan security rules...</p>';
  
  try {
    // Inisialisasi Firebase
    const testApp = firebase.initializeApp(defaultFirebaseConfig);
    const db = firebase.firestore();
    
    // Terapkan Firestore Rules
    const firestoreRules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read and write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Users can read their own orders and write new orders
    match /orders/{orderId} {
      allow read: if request.auth != null && resource.data.uid == request.auth.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
      allow update: if request.auth != null && request.auth.uid == resource.data.uid;
    }
    
    // Users can manage their own requests
    match /requests/{requestId} {
      alert('Rules diterapkan secara manual di Firebase Console!');
    }
    
    // Products can be read by everyone, written only by admin
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // Coupons can be read by everyone
    match /coupons/{couponId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}`;
    
    // Terapkan Storage Rules
    const storageRules = `rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Anyone can read public files
    match /public/{allPaths=**} {
      allow read;
    }
    
    // Only authenticated users can upload to their own folder
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Request files
    match /requests/{requestId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}`;
    
    resultsDiv.innerHTML = `
      <div class="info-box" style="margin-top: 15px;">
        ‚ÑπÔ∏è <strong>Rules Harus Diterapkan Manual!</strong><br>
        <small>Copy kode rules dari Step 3 dan paste di Firebase Console:</small><br>
        <small>‚Ä¢ Firestore ‚Üí Rules</small><br>
        <small>‚Ä¢ Storage ‚Üí Rules</small>
      </div>
      <div class="code-block" style="margin-top: 15px; position: relative;">
        <button class="copy-btn" onclick="copyToClipboard('firestore-rules-test')" style="position: absolute; top: 10px; right: 10px; background: var(--pink); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">Copy Firestore Rules</button>
        <pre id="firestore-rules-test">${firestoreRules}</pre>
      </div>
      <div class="code-block" style="margin-top: 10px; position: relative;">
        <button class="copy-btn" onclick="copyToClipboard('storage-rules-test')" style="position: absolute; top: 10px; right: 10px; background: var(--pink); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">Copy Storage Rules</button>
        <pre id="storage-rules-test">${storageRules}</pre>
      </div>
    `;
  } catch (error) {
    resultsDiv.innerHTML = `
      <div class="warning-box" style="margin-top: 15px;">
        ‚ùå <strong>Gagal Menerapkan Rules!</strong><br>
        <small>Error: ${error.message}</small>
      </div>
    `;
  }
};

// Tambahkan fungsi copyToClipboard jika belum ada
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;
  
  navigator.clipboard.writeText(text).then(() => {
    const btn = element.previousElementSibling;
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    
    setTimeout(() => {
      btn.textContent = 'Copy';
      btn.classList.remove('copied');
    }, 2000);
  });
}

// Tambahkan tombol test ke Step 1
document.addEventListener('DOMContentLoaded', () => {
  // Set default config in textarea
  document.getElementById('firebaseConfig').value = JSON.stringify(defaultFirebaseConfig, null, 2);
  
  // Tambahkan tombol test ke Step 1
  const configStatusDiv = document.getElementById('configStatus');
  if (configStatusDiv) {
    const testButton = document.createElement('button');
    testButton.className = 'btn';
    testButton.textContent = 'Test Firebase Connection';
    testButton.onclick = testFirebaseConnection;
    testButton.style.marginTop = '15px';
    configStatusDiv.appendChild(testButton);
  }
});
</script>
